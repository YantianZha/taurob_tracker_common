<?xml version="1.0"?>

<robot name="taurob_tracker" 
	xmlns:xacro="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface" 
	xmlns:controller="http://playerstage.sourceforge.net/gazebo/xmlschema/#controller"
    	xmlns:interface="http://playerstage.sourceforge.net/gazebo/xmlschema/#interface">
  
    <xacro:include filename="$(find hector_xacro_tools)/urdf/inertia_tensors.urdf.xacro" />

    <xacro:include filename="$(find hector_tracked_vehicles_description)/urdf/tracked_wheel.urdf.xacro" />
    
    <property name="base_size_x" value="${0.365*2}" />
    <property name="base_size_y" value="0.24" />
    <property name="base_size_z" value="0.312 " />
    
    <property name="base_offset_x" value="-0.122" />
    <property name="base_offset_z" value="-0.05" />

    <property name="wheel_radius_big" value="0.085" />
    <property name="wheel_length" value="0.02" />
    <property name="wheel_size_y" value="0.02" /> 
    <property name="wheel_offset_y" value="0.25" />
    <property name="wheel_offset_z_from_base_link" value="-0.0" />
    
    <xacro:property name="wheel_radius" value="0.2" />
    <xacro:property name="diff_z_offset" value="-0.12" />
    
    <macro name="tracker_chassis_macro">
    
    <link name="base_link"/>
      
    <joint name="chassis_joint" type="fixed">
      <origin xyz="${-base_offset_x} 0 0.18" rpy="0 0 0"/>
      <parent link="base_link"/>
      <child link="chassis_link"/>
    </joint>

	<link name="flipper_link">
		<origin xyz="0 0 0" rpy="0 0 0" />
               
            
	    <collision>
              <origin xyz="0.5 -0.23 ${base_offset_z}" rpy="0 0 0"/>
              <geometry>
                <box size="1.05 0.14 0.35"/>
              </geometry>
	    </collision>
	    <collision>
              <origin xyz="0.5 0.23 ${base_offset_z}" rpy="0 0 0"/>
              <geometry>
                <box size="1.05 0.14 0.35"/>
              </geometry>
	    </collision>
 
        </link>
    
<joint name="flipper_front" type="revolute"> 
      <origin xyz="${base_offset_x-0.5} 0 0" rpy="0 0 0" />   
      <axis xyz="0 -1 0"/>
	     
	 <limit lower="${-30 * M_PI / 180}" upper="${50 * M_PI / 180}"
             effort="204" velocity="${1.0 * 110 * M_PI / 180}" />
        <safety_controller soft_lower_limit="${-25 * M_PI / 180}"
                         soft_upper_limit="${45 * M_PI / 180}"
                         k_position="${100}"
                         k_velocity="${2}"/>
     
      <parent link="chassis_link"/>
      <child link="flipper_link"/>
    </joint>


   <link name="chassis_link">
	    
    <xacro:inertial_cuboid_with_pose mass="20" x_length="${base_size_x}" y_length="${base_size_y}" z_length="${base_size_z}" >
      <origin xyz="0.0 0.0 ${0.312*0.5}" rpy="0 0 0" />
    </xacro:inertial_cuboid_with_pose>
            <visual>
                <origin xyz="0.0 0.0 0.0" rpy="0 0 0" />
                <geometry>
                    <mesh filename="package://taurob_tracker_description/meshes/tracker_chassis.dae"/>
                </geometry>
                
            </visual>
        
	    <collision>
              <origin xyz="${base_offset_x-0.11} 0.0 ${base_offset_z}" rpy="0 0 0"/>
              <geometry>
                <box size="0.74 0.5 0.2"/>
              </geometry>
	    </collision>
	    <collision>
              <origin xyz="${base_offset_x} -0.23 ${base_offset_z}" rpy="0 0 0"/>
              <geometry>
                <box size="1.05 0.14 0.35"/>
              </geometry>
	    </collision>
	    <collision>
              <origin xyz="${base_offset_x} 0.23 ${base_offset_z}" rpy="0 0 0"/>
              <geometry>
                <box size="1.05 0.14 0.35"/>
              </geometry>
	    </collision>
     
        </link>

	<!--<tracked_wheel parent="base_link" prefix="left_0" offset_x= "0.21100" offset_y = "${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>-->
        <tracked_wheel parent="base_link" prefix="left_1" offset_x= "-0.1" offset_y = "${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>
	<!--<tracked_wheel parent="base_link" prefix="left_2" offset_x= "-0.21100" offset_y = "${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>-->
	<tracked_wheel parent="base_link" prefix="left_3" offset_x= "0.10" offset_y = "${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>
	<!--<tracked_wheel parent="base_link" prefix="left_4" offset_x= "-0.10550" offset_y = "${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>-->
	<!--<tracked_wheel parent="base_link" prefix="right_0" offset_x= "0.21100" offset_y = "-${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>-->
	<tracked_wheel parent="base_link" prefix="right_1" offset_x= "-0.1" offset_y = "-${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>
	<!--<tracked_wheel parent="base_link" prefix="right_2" offset_x= "-0.21100" offset_y = "-${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>-->
	<tracked_wheel parent="base_link" prefix="right_3" offset_x= "0.1" offset_y = "-${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>
	<!--<tracked_wheel parent="base_link" prefix="right_4" offset_x= "0.10550" offset_y = "-${wheel_offset_y}" offset_z = "${wheel_offset_z_from_base_link}" reflect="1" wheel_radius="${wheel_radius_big}"/>-->

        
 <!--   <joint name="caster_front_joint" type="fixed">
      <parent link="base_link"/>
      <child link="caster_front_link"/>
      <origin xyz="0.265 0.0 ${0.01+wheel_offset_z_from_base_link}" rpy="${-M_PI/2} 0 0"/>
    </joint>
    
    <link name="caster_front_link">
      <collision>
        <geometry>
          <cylinder length="0.0176" radius="${wheel_radius_big}"/>
        </geometry>
        <origin rpy="0 0 0" xyz="0 0 0"/>
      </collision>      
      <inertial>
        <mass value="0.01" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.001" ixy="0.0" ixz="0.0"
                 iyy="0.001" iyz="0.0" 
                 izz="0.001" />
      </inertial>
    </link>
    
    <joint name="caster_back_joint" type="fixed">
      <parent link="base_link"/>
      <child link="caster_back_link"/>
      <origin xyz="-0.265 0.0 ${0.01+wheel_offset_z_from_base_link}" rpy="${-M_PI/2} 0 0"/>
    </joint>
    <link name="caster_back_link">
      <collision>
        <geometry>
          <cylinder length="0.0176" radius="${wheel_radius_big}"/>
        </geometry>
        <origin rpy="0 0 0" xyz="0 0 0"/>
      </collision>      
      <inertial>
        <mass value="0.01" />
        <origin xyz="0 0 0" />
        <inertia ixx="0.001" ixy="0.0" ixz="0.0"
                 iyy="0.001" iyz="0.0" 
                 izz="0.001" />
      </inertial>
    </link>
        
          <gazebo reference="caster_front_link">
            <mu1>0.0</mu1>
            <mu2>0.0</mu2>
            <kp>1000000.0</kp>
            <kd>100.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>1.0</maxVel>
          </gazebo>
          
          <gazebo reference="caster_back_link">
            <mu1>0.0</mu1>
            <mu2>0.0</mu2>
            <kp>1000000.0</kp>
            <kd>100.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>1.0</maxVel>
          </gazebo>-->
          
          <gazebo reference="chassis_link">
            <mu1>0.0</mu1>
            <mu2>0.0</mu2>
            <kp>1000000.0</kp>
            <kd>100.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>1.0</maxVel>
          </gazebo>
          
          <gazebo reference="flipper_link">
            <mu1>0.0</mu1>
            <mu2>0.0</mu2>
            <kp>1000000.0</kp>
            <kd>100.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>1.0</maxVel>
          </gazebo>
          
          <gazebo reference="base_link">
            <mu1>0.0</mu1>
            <mu2>0.0</mu2>
            <kp>1000000.0</kp>
            <kd>100.0</kd>
            <minDepth>0.001</minDepth>
            <maxVel>1.0</maxVel>
          </gazebo>
        

   <gazebo>
            
        <plugin name="diffdrive_plugin_multiwheel" filename="libdiffdrive_plugin_multi_wheel.so">                
                <alwaysOn>true</alwaysOn>
                <updateRate>25.0</updateRate>
                <leftJoints>left_1_wheel_joint  left_3_wheel_joint </leftJoints>
                <rightJoints>right_1_wheel_joint right_3_wheel_joint</rightJoints>
                <wheelSeparation>${wheel_offset_y*2}</wheelSeparation>
                <wheelDiameter>${wheel_radius_big*2}</wheelDiameter>
                <torque>50000</torque>
                <interface:position name="position_iface_2"/>
                <robotNamespace>/</robotNamespace>
                <robotBaseFrame>base_link</robotBaseFrame>
                <commandTopic>/cmd_vel_raw</commandTopic>
                <publishOdometryTf>0</publishOdometryTf>
                <publishOdometryMsg>1</publishOdometryMsg>
        </plugin>
        
  </gazebo>
    </macro>
    
    
</robot>
